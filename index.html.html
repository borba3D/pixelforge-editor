<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelForge Editor 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .controls-panel::-webkit-scrollbar { width: 6px; }
        .controls-panel::-webkit-scrollbar-track { background: #e2e8f0; }
        .controls-panel::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 3px; }
        .sidebar-button { transition: all 0.2s ease-in-out; }
        .sidebar-button.active { background-color: #e0e7ff; color: #3730a3; font-weight: 600; }
        .sidebar-button.disabled { opacity: 0.5; pointer-events: none; color: #9ca3af; }
        #drop-zone.dragover { border-color: #4f46e5; background-color: #eef2ff; }
        .hidden { display: none; }
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        .summary-arrow { transition: transform 0.2s; }
        details[open] .summary-arrow { transform: rotate(90deg); }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.25rem; }
        .hdri-preset-btn {
            outline: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .hdri-preset-btn.active {
            outline-color: #4f46e5;
            transform: scale(1.05);
        }
        .toolbar-button.active {
            background-color: #4f46e5;
            color: white;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Tela de Carregamento Global -->
    <div id="global-loader" class="hidden fixed inset-0 bg-white bg-opacity-80 z-50 flex items-center justify-center">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p id="loader-text" class="mt-2 text-gray-600">Carregando...</p>
        </div>
    </div>

    <!-- Modal de Novo Projeto -->
    <div id="new-project-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
             <h3 class="text-lg font-bold mb-4">Criar Novo Projeto</h3>
             <label for="new-project-name-input" class="block text-sm font-medium text-gray-700">Nome do Projeto</label>
             <input type="text" id="new-project-name-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
             <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-new-project-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="confirm-new-project-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Criar Projeto</button>
             </div>
        </div>
    </div>
    
    <!-- Modal de Exportação -->
    <div id="export-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Código de Incorporação (iframe)</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <p class="text-sm text-gray-600 mb-2">Copie e cole este código no HTML do seu site. Lembre-se de hospedar este arquivo <code class="text-xs">.html</code> e o seu modelo <code class="text-xs">.glb</code> em um servidor.</p>
            <textarea id="export-code-textarea" readonly class="w-full h-32 p-2 bg-gray-100 text-gray-800 border rounded font-mono text-xs"></textarea>
            <button id="copy-code-btn" class="mt-4 w-full text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg px-4 py-2">Copiar Código</button>
        </div>
    </div>

    <!-- Tela de Projetos (Dashboard) -->
    <div id="dashboard-view" class="hidden">
        <header class="bg-white h-16 flex items-center justify-between px-6 border-b border-gray-200">
            <div class="flex items-center">
                <h1 class="text-2xl font-bold text-gray-800">PixelForge</h1>
                <div class="h-1 w-24 ml-2 bg-gradient-to-r from-blue-600 via-purple-500 to-red-500 rounded-full"></div>
            </div>
            <h2 class="text-lg font-semibold text-gray-700">Meus Projetos</h2>
        </header>
        <main class="p-8">
            <button id="new-project-btn" class="mb-8 flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-blue-700 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                Novo Projeto
            </button>
            <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Cards de projeto serão injetados aqui -->
            </div>
             <div id="no-projects-message" class="hidden text-center py-16">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Nenhum projeto encontrado</h3>
                <p class="mt-1 text-sm text-gray-500">Clique em "Novo Projeto" para começar.</p>
            </div>
        </main>
    </div>

    <!-- Tela do Editor -->
    <div id="editor-view" class="hidden">
        <div class="flex h-screen bg-gray-100">
            <aside class="w-64 bg-white flex flex-col border-r border-gray-200">
                 <div class="px-6 py-4 border-b border-gray-200 flex items-center gap-3">
                    <button id="back-to-dashboard-btn" class="p-1 text-gray-500 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <h1 class="text-xl font-bold text-gray-800">PixelForge</h1>
                </div>
                <nav id="pipeline-nav" class="flex-1 px-4 py-4 space-y-2">
                    <a href="#" id="nav-import" class="sidebar-button flex items-center px-4 py-2.5 text-sm font-medium rounded-lg">1. Importar Objeto</a>
                    <a href="#" id="nav-materials" class="sidebar-button flex items-center px-4 py-2.5 text-sm font-medium rounded-lg disabled">2. Texturizar</a>
                    <a href="#" id="nav-environment" class="sidebar-button flex items-center px-4 py-2.5 text-sm font-medium rounded-lg disabled">3. Iluminar</a>
                    <a href="#" id="nav-viewer" class="sidebar-button flex items-center px-4 py-2.5 text-sm font-medium rounded-lg disabled">4. Setup Final</a>
                    <a href="#" id="nav-thumbnail" class="sidebar-button flex items-center px-4 py-2.5 text-sm font-medium rounded-lg disabled">5. Gerar Thumbnail</a>
                    <a href="#" id="nav-export" class="sidebar-button flex items-center px-4 py-2.5 text-sm font-medium rounded-lg disabled">6. Gerar Código</a>
                </nav>
            </aside>
            <div class="flex-1 flex flex-col">
                <header class="bg-white h-16 flex items-center justify-between px-6 border-b border-gray-200">
                    <input type="text" id="project-title-input" placeholder="Projeto sem Título" class="text-lg font-semibold text-gray-700 bg-transparent focus:outline-none focus:ring-0 border-none p-0">
                    <button id="save-project-btn" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white text-sm font-semibold rounded-lg shadow-md hover:opacity-90 transition-opacity">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        Salvar Projeto
                    </button>
                </header>
                <div class="flex-1 flex overflow-hidden">
                    <main id="viewer-container" class="flex-1 relative bg-gray-200">
                        <div id="transform-toolbar" class="hidden absolute bottom-5 left-1/2 -translate-x-1/2 bg-white/80 backdrop-blur-sm shadow-xl rounded-full p-2 flex items-center gap-2 z-20">
                             <button id="select-btn" class="toolbar-button p-3 rounded-full hover:bg-gray-200 text-gray-600" title="Selecionar (Q)"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" transform="rotate(-45 10 10)"></path></svg></button>
                             <button id="translate-btn" class="toolbar-button p-3 rounded-full hover:bg-gray-200 text-gray-600" title="Mover (W)"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                             <button id="rotate-btn" class="toolbar-button p-3 rounded-full hover:bg-gray-200 text-gray-600" title="Rotacionar (E)"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
                             <button id="scale-btn" class="toolbar-button p-3 rounded-full hover:bg-gray-200 text-gray-600" title="Escala (R)"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4h4m12 4V4h-4M4 16v4h4m12-4v4h-4"></path></svg></button>
                        </div>
                    </main>
                    <aside id="right-panel" class="w-96 bg-white p-6 overflow-y-auto controls-panel border-l border-gray-200">
                        <div id="panel-import" class="hidden space-y-6">
                             <h2 class="text-xl font-bold text-gray-800">1. Importar Modelo</h2>
                             <label id="drop-zone" for="file-input" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clique ou arraste</span> seu arquivo .glb para começar</p>
                                    <p class="text-xs text-gray-500">GLB ou GLTF</p>
                                </div>
                                <input type="file" id="file-input" accept=".glb,.gltf" class="hidden"/>
                            </label>
                            <p id="loading-status" class="text-xs text-gray-500 mt-2"></p>
                        </div>
                        <div id="panel-materials" class="hidden space-y-6">
                             <h2 class="text-xl font-bold text-gray-800">2. Texturizar</h2>
                             <div id="materials-container" class="space-y-4"></div>
                        </div>
                        <div id="panel-environment" class="hidden space-y-6">
                             <h2 class="text-xl font-bold text-gray-800">3. Iluminação e Ambiente</h2>
                             <div class="space-y-6">
                                <div>
                                    <h3 class="text-base font-semibold text-gray-700 mb-2">Presets de Ambiente (HDRI)</h3>
                                    <div id="hdri-presets-container" class="grid grid-cols-3 gap-2">
                                        <!-- Presets de HDRI serão injetados aqui -->
                                    </div>
                                </div>
                                <div>
                                    <label for="hdri-input" class="block text-sm font-medium text-gray-700 mb-2">Carregar Fundo Personalizado</label>
                                    <input type="file" id="hdri-input" accept=".hdr,.png,.jpg,.jpeg" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer border border-gray-300 rounded-lg"/>
                                </div>
                                <div>
                                    <h3 class="text-base font-semibold text-gray-700 mb-2">Ajustes de Luz</h3>
                                    <div id="light-controls" class="p-4 bg-gray-50 rounded-lg border space-y-4">
                                        <!-- Controles de Luz serão injetados aqui -->
                                    </div>
                                </div>
                             </div>
                        </div>
                        <div id="panel-viewer" class="hidden space-y-6">
                             <h2 class="text-xl font-bold text-gray-800">4. Setup Final</h2>
                             <div class="space-y-4">
                                <button id="set-initial-view-btn" class="w-full text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg px-4 py-2">Salvar Posição Inicial da Câmera</button>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Limite de Zoom (Mín / Máx)</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="zoom-min-input" placeholder="Mín" class="w-full bg-gray-100 p-2 rounded text-center border">
                                        <input type="number" id="zoom-max-input" placeholder="Máx" class="w-full bg-gray-100 p-2 rounded text-center border">
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="text-sm font-medium text-gray-700">Girar Automaticamente</label>
                                    <label class="relative inline-flex items-center cursor-pointer"><input id="auto-rotate-toggle" type="checkbox" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                                </div>
                                <div id="auto-rotate-controls" class="hidden space-y-2">
                                     <div>
                                        <label for="auto-rotate-speed" class="block text-sm font-medium text-gray-700 mb-1">Velocidade da Rotação</label>
                                        <input type="range" id="auto-rotate-speed" min="0.1" max="10" step="0.1" value="2" class="w-full">
                                    </div>
                                </div>
                             </div>
                        </div>
                        <div id="panel-thumbnail" class="hidden space-y-6">
                            <h2 class="text-xl font-bold text-gray-800">5. Gerar Thumbnail</h2>
                            <p class="text-sm text-gray-600">Posicione o modelo na cena. A imagem abaixo será usada como a capa do seu projeto.</p>
                            <div id="thumbnail-preview-container" class="w-full aspect-video bg-gray-200 rounded-lg border flex items-center justify-center overflow-hidden">
                                <span class="text-sm text-gray-500">A prévia aparecerá aqui</span>
                            </div>
                            <button id="generate-thumbnail-btn" class="w-full text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg px-4 py-2">Gerar Prévia da Thumbnail</button>
                        </div>
                        <div id="panel-export" class="hidden space-y-6">
                            <h2 class="text-xl font-bold text-gray-800">6. Gerar Código</h2>
                             <div class="space-y-4">
                                <p class="text-sm text-gray-600">Finalize e exporte seu visualizador.</p>
                                <button id="generate-code-btn" class="w-full text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg px-4 py-3">Gerar Código de Incorporação</button>
                                <button id="download-zip-btn" class="w-full text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg px-4 py-3">Baixar Arquivos (.zip)</button>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        // Importações
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, setDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, uploadString } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';

        // Config Firebase
        const firebaseConfig = { apiKey: "COLE_SUA_API_KEY_AQUI", authDomain: "SEU_PROJETO.firebaseapp.com", projectId: "SEU_PROJETO_ID", storageBucket: "SEU_PROJETO.appspot.com", messagingSenderId: "SEU_SENDER_ID", appId: "SEU_APP_ID" };
        
        // Variáveis globais
        let app, auth, db, storage, userId, currentProjectId = null, modelFile = null, thumbnailDataUrl = null;
        let scene, camera, renderer, orbitControls, clock, currentModel, dirLight, ambientLight, gridHelper, hdriTexture, transformControls, groundPlane;
        let materialsMap = new Map();
        let isThreeInitialized = false;
        
        const hdriPresets = [
            { name: 'Estúdio', url: 'https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/studio_small_03_1k.hdr', thumb: 'https://placehold.co/100x50/a3a3a3/ffffff?text=Est%C3%BAdio' },
            { name: 'Exterior', url: 'https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/syferfontein_1d_clear_1k.hdr', thumb: 'https://placehold.co/100x50/60a5fa/ffffff?text=Exterior' },
            { name: 'Noite', url: 'https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/venice_sunset_1k.hdr', thumb: 'https://placehold.co/100x50/1e3a8a/ffffff?text=Noite' },
        ];
        
        // --- Lógica de Inicialização e UI ---
        
        function initializeFirebase() {
             if (firebaseConfig.apiKey === "COLE_SUA_API_KEY_AQUI") {
                 console.warn("Firebase não configurado.");
                 showDashboard(); 
                 return;
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    showDashboard();
                } else {
                    signInAnonymously(auth).catch(err => console.error(err));
                }
            });
        }

        function showDashboard() {
            document.getElementById('editor-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            if (userId) loadProjects();
        }

        function showEditor(projectId, projectName) {
            currentProjectId = projectId;
            document.getElementById('project-title-input').value = projectName;
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('editor-view').classList.remove('hidden');
            
            if (!isThreeInitialized) {
                initThreeScene();
            }
            
            resetEditorState();
            
            if (projectId) {
                // Carregar dados do projeto
            } else {
                showPanel('panel-import');
            }
        }
        
        function showPanel(panelId) {
            document.querySelectorAll('#right-panel > div').forEach(p => p.classList.add('hidden'));
            const activePanel = document.getElementById(panelId);
            if(activePanel) activePanel.classList.remove('hidden');

            document.querySelectorAll('#pipeline-nav a').forEach(b => b.classList.remove('active'));
            const activeNav = document.getElementById(panelId.replace('panel-', 'nav-'));
            if (activeNav) activeNav.classList.add('active');
        }

        function resetEditorState() {
            thumbnailDataUrl = null;
            modelFile = null;
            if (currentModel) {
                scene.remove(currentModel);
                transformControls.detach();
                currentModel = null;
            }
            document.querySelectorAll('#pipeline-nav a').forEach((el, index) => {
                 el.classList.toggle('disabled', index > 0);
            });
            document.getElementById('transform-toolbar').classList.add('hidden');
            loadHDRI(hdriPresets[0].url, false);
            showPanel('panel-import');
        }
        
        // --- Lógica de Projetos ---
        async function loadProjects() { /* ... */ }
        
        async function saveProject() {
            if (!userId) return alert('Você precisa configurar o Firebase para salvar.');
            if (!currentProjectId) {
                currentProjectId = doc(collection(db, `users/${userId}/projects`)).id;
            }
            setLoading(true, 'Salvando...');
            try {
                const projectTitle = document.getElementById('project-title-input').value;
                const docRef = doc(db, `users/${userId}/projects`, currentProjectId);
                const docSnap = await getDoc(docRef);
                const existingData = docSnap.exists() ? docSnap.data() : {};

                let modelURL = existingData.modelURL || null;
                let thumbnailURL = existingData.thumbnailURL || null;

                if (modelFile) {
                    const modelRef = ref(storage, `users/${userId}/${currentProjectId}/${modelFile.name}`);
                    await uploadBytes(modelRef, modelFile);
                    modelURL = await getDownloadURL(modelRef);
                }
                
                if (thumbnailDataUrl) {
                     const thumbRef = ref(storage, `users/${userId}/${currentProjectId}/thumbnail.png`);
                     await uploadString(thumbRef, thumbnailDataUrl, 'data_url');
                     thumbnailURL = await getDownloadURL(thumbRef);
                }

                const projectData = {
                    title: projectTitle,
                    updatedAt: serverTimestamp(),
                };
                if (modelURL) projectData.modelURL = modelURL;
                if (thumbnailURL) projectData.thumbnailURL = thumbnailURL;
                
                await setDoc(docRef, projectData, { merge: true });

                alert('Projeto salvo com sucesso!');
            } catch(error) {
                console.error("Erro ao salvar o projeto:", error);
                alert("Ocorreu um erro ao salvar o projeto.");
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading, text = 'Carregando...') {
            const loader = document.getElementById('global-loader');
            document.getElementById('loader-text').textContent = text;
            loader.classList.toggle('hidden', !isLoading);
        }
        
        // --- Lógica de Thumbnail ---
        function generateThumbnail() {
            if (!renderer) return;
            renderer.render(scene, camera);
            thumbnailDataUrl = renderer.domElement.toDataURL('image/png');
            const previewContainer = document.getElementById('thumbnail-preview-container');
            previewContainer.innerHTML = `<img src="${thumbnailDataUrl}" class="w-full h-full object-contain">`;
        }

        // --- Lógica do Three.js e Ambiente ---
        function initThreeScene() {
            const viewerContainer = document.getElementById('viewer-container');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f2f5);
            clock = new THREE.Clock();
            camera = new THREE.PerspectiveCamera(50, viewerContainer.clientWidth / viewerContainer.clientHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(viewerContainer.clientWidth, viewerContainer.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            viewerContainer.appendChild(renderer.domElement);
            
            orbitControls = new OrbitControls(camera, renderer.domElement);
            orbitControls.enableDamping = true;

            ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
            dirLight.position.set(5, 10, 7.5);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            dirLight.shadow.radius = 5;
            scene.add(dirLight);

            gridHelper = new THREE.GridHelper(20, 20);
            scene.add(gridHelper);

            const planeGeometry = new THREE.PlaneGeometry(100, 100);
            const planeMaterial = new THREE.ShadowMaterial({ opacity: 0.3 });
            groundPlane = new THREE.Mesh(planeGeometry, planeMaterial);
            groundPlane.rotation.x = -Math.PI / 2;
            groundPlane.receiveShadow = true;
            scene.add(groundPlane);

            transformControls = new TransformControls(camera, renderer.domElement);
            transformControls.addEventListener('dragging-changed', (event) => orbitControls.enabled = !event.value);
            scene.add(transformControls);

            window.addEventListener('resize', () => {
                camera.aspect = viewerContainer.clientWidth / viewerContainer.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(viewerContainer.clientWidth, viewerContainer.clientHeight);
            });

            isThreeInitialized = true;
            
            setupEnvironmentControls();
            setupToolbar();
            setupViewerControls();
            setupExportControls();
            setupDragAndDrop();
            animate();
        }

        function animate() {
            if (!isThreeInitialized) return;
            requestAnimationFrame(animate);
            orbitControls.update();
            renderer.render(scene, camera);
        }

        function loadHDRI(url, setAsBackground = false) {
            const loader = url.endsWith('.hdr') ? new RGBELoader() : new THREE.TextureLoader();
            loader.load(url, (texture) => {
                texture.mapping = THREE.EquirectangularReflectionMapping;
                scene.environment = texture;
                hdriTexture = texture;
                
                if (setAsBackground) {
                    scene.background = texture;
                    document.getElementById('hdri-visible-toggle-input').checked = true;
                } else if (!document.getElementById('hdri-visible-toggle-input')?.checked) {
                    scene.background = new THREE.Color(0xf0f2f5);
                }

                document.querySelectorAll('.hdri-preset-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.url === url);
                });
            });
        }
        
        function setupEnvironmentControls() {
            const presetsContainer = document.getElementById('hdri-presets-container');
            presetsContainer.innerHTML = '';
            hdriPresets.forEach(preset => {
                const button = document.createElement('button');
                button.className = 'hdri-preset-btn rounded-lg overflow-hidden focus:outline-none relative';
                button.dataset.url = preset.url;
                button.innerHTML = `<img src="${preset.thumb}" alt="${preset.name}" class="w-full h-full object-cover"><span class="absolute inset-0 bg-black bg-opacity-30 text-white text-xs font-bold flex items-center justify-center">${preset.name}</span>`;
                button.onclick = () => loadHDRI(preset.url, document.getElementById('hdri-visible-toggle-input').checked);
                presetsContainer.appendChild(button);
            });
            document.getElementById('hdri-input').addEventListener('change', (e) => {
                if(e.target.files.length) loadHDRI(URL.createObjectURL(e.target.files[0]), true);
            });
            const lightControlsContainer = document.getElementById('light-controls');
            lightControlsContainer.innerHTML = `
                ${createToggleHTML('grid-toggle', 'Mostrar Grade do Chão', true)}
                ${createToggleHTML('hdri-visible-toggle', 'Mostrar Fundo HDRI', false)}
                ${createSliderHTML('light-intensity', 'Brilho da Luz', dirLight.intensity, 0, 5, 0.1)}
                ${createToggleHTML('shadows-toggle', 'Sombras', dirLight.castShadow)}
                <div id="shadow-controls-container" class="${dirLight.castShadow ? '' : 'hidden'}">
                    ${createSliderHTML('shadow-opacity', 'Opacidade da Sombra', groundPlane.material.opacity, 0, 1, 0.05)}
                    ${createSliderHTML('shadow-softness', 'Suavidade da Sombra', dirLight.shadow.radius, 0, 10, 0.1)}
                </div>
                ${createSliderHTML('light-position', 'Posição da Luz', 45, 0, 360, 1)}
            `;
            document.getElementById('grid-toggle-input').addEventListener('change', (e) => gridHelper.visible = e.target.checked);
            document.getElementById('hdri-visible-toggle-input').addEventListener('change', (e) => {
                 if (e.target.checked && hdriTexture) scene.background = hdriTexture;
                 else scene.background = new THREE.Color(0xf0f2f5);
            });
            document.getElementById('light-intensity-slider').addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                dirLight.intensity = val;
                document.getElementById('light-intensity-value').textContent = `${(val * 100 / 5).toFixed(0)}%`;
            });
            document.getElementById('shadows-toggle-input').addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                dirLight.castShadow = isChecked;
                groundPlane.visible = isChecked;
                document.getElementById('shadow-controls-container').style.display = isChecked ? 'block' : 'none';
            });
            document.getElementById('shadow-opacity-slider').addEventListener('input', (e) => {
                 const val = parseFloat(e.target.value);
                 groundPlane.material.opacity = val;
                 document.getElementById('shadow-opacity-value').textContent = `${(val * 100).toFixed(0)}%`;
            });
             document.getElementById('shadow-softness-slider').addEventListener('input', (e) => {
                 const val = parseFloat(e.target.value);
                 dirLight.shadow.radius = val;
                 document.getElementById('shadow-softness-value').textContent = `${(val * 10).toFixed(0)}%`;
            });
            document.getElementById('light-position-slider').addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                const angle = THREE.MathUtils.degToRad(val);
                dirLight.position.set(Math.cos(angle) * 10, 10, Math.sin(angle) * 10);
                document.getElementById('light-position-value').textContent = `${val.toFixed(0)}°`;
            });
        }
        
        function createSliderHTML(id, label, value, min, max, step, invertLabel = false) {
             const displayValue = invertLabel ? max - value + min : value;
             let displayLabel;
             if (label.includes('Posição')) {
                displayLabel = `${displayValue.toFixed(0)}°`;
             } else {
                displayLabel = `${(displayValue * 100 / max).toFixed(0)}%`;
             }
             return `<div class="text-sm">
                        <label for="${id}-slider" class="block text-gray-600 mb-1">${label} (<span id="${id}-value">${displayLabel}</span>)</label>
                        <input type="range" id="${id}-slider" min="${min}" max="${max}" step="${step}" value="${value}" class="w-full">
                     </div>`;
        }
        function createToggleHTML(id, label, checked) {
             return `<div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700">${label}</label>
                        <label class="relative inline-flex items-center cursor-pointer"><input id="${id}-input" type="checkbox" ${checked ? 'checked' : ''} class="sr-only peer"><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                     </div>`;
        }

        // --- Lógica de Importação ---
        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, e => e.preventDefault()));
            ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover')));
            ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover')));
            dropZone.addEventListener('drop', (event) => {
                if (event.dataTransfer.files.length) handleFile(event.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) handleFile(e.target.files[0]);
            });
        }

        function handleFile(file) {
             if (file && (file.name.endsWith('.glb') || file.name.endsWith('.gltf'))) {
                 modelFile = file;
                 loadModel(URL.createObjectURL(file));
             } else {
                 alert('Por favor, selecione um arquivo .glb ou .gltf válido.');
             }
        }
        
        function loadModel(url) {
            if (currentModel) scene.remove(currentModel);
            const dracoLoader = new DRACOLoader().setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
            const loader = new GLTFLoader().setDRACOLoader(dracoLoader);
            document.getElementById('loading-status').textContent = 'Carregando...';

            loader.load(url, (gltf) => {
                currentModel = gltf.scene;
                currentModel.traverse(node => {
                    if (node.isMesh) {
                        node.castShadow = true;
                        node.receiveShadow = true;
                    }
                });
                const box = new THREE.Box3().setFromObject(currentModel);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                currentModel.position.sub(center);
                const scale = 5 / Math.max(size.x, size.y, size.z);
                currentModel.scale.setScalar(scale);
                scene.add(currentModel);
                transformControls.attach(currentModel);
                document.getElementById('transform-toolbar').classList.remove('hidden');

                document.getElementById('loading-status').textContent = 'Carregado com sucesso!';
                document.querySelectorAll('#pipeline-nav a').forEach(el => el.classList.remove('disabled'));
                setupMaterials(currentModel);
                showPanel('panel-materials');
            }, undefined, (error) => {
                console.error(error);
                document.getElementById('loading-status').textContent = 'Erro ao carregar o modelo.';
            });
        }
        
        // --- Lógica de Materiais ---
        function setupMaterials(model) {
            const container = document.getElementById('materials-container');
            container.innerHTML = '';
            materialsMap.clear();

            model.traverse((node) => {
                if (node.isMesh && node.material) {
                    if (!materialsMap.has(node.material.uuid)) {
                        materialsMap.set(node.material.uuid, node.material);
                    }
                }
            });
            
            if (materialsMap.size === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">Nenhum material editável encontrado.</p>';
                return;
            }

            for (const [uuid, material] of materialsMap.entries()) {
                if (material.isMeshStandardMaterial) {
                    container.appendChild(createMaterialEditor(uuid, material));
                }
            }
        }
        
        function createMaterialEditor(uuid, material) {
            const wrapper = document.createElement('details');
            wrapper.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200';
            wrapper.open = true;

            const summary = document.createElement('summary');
            summary.className = 'font-semibold text-gray-800 text-sm flex justify-between items-center';
            summary.innerHTML = `<span>${material.name || `Material (${uuid.substring(0, 4)})`}</span><svg class="w-4 h-4 text-gray-500 summary-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
            
            const content = document.createElement('div');
            content.className = 'mt-4 space-y-4 pt-4 border-t border-gray-200';
            
            const maps = {
                map: { label: 'BaseColor', color: material.color, colorProperty: 'color' },
                metalnessMap: { label: 'Metallic', slider: material.metalness, sliderProperty: 'metalness' },
                roughnessMap: { label: 'Roughness', slider: material.roughness, sliderProperty: 'roughness' },
                aoMap: { label: 'Ambient Occlusion' },
                normalMap: { label: 'Normal' },
                emissiveMap: { label: 'Emissive', color: material.emissive, colorProperty: 'emissive', slider: material.emissiveIntensity, sliderProperty: 'emissiveIntensity' },
                displacementMap: { label: 'Displacement', slider: material.displacementScale, sliderProperty: 'displacementScale' },
            };

            Object.entries(maps).forEach(([key, props]) => {
                const section = document.createElement('div');
                if (props.color) section.appendChild(createColorPicker(uuid, props.label, props.color, props.colorProperty));
                if (props.slider !== undefined) section.appendChild(createSlider(uuid, props.label, props.slider, props.sliderProperty, 0, key === 'emissiveIntensity' ? 5 : 1));
                section.appendChild(createTextureInput(uuid, `Mapa de ${props.label}`, key));
                content.appendChild(section);
            });
            
            wrapper.appendChild(summary);
            wrapper.appendChild(content);
            return wrapper;
        }
        
        function createColorPicker(uuid, label, color, property) {
            const el = document.createElement('div');
            el.className = 'flex items-center justify-between text-sm';
            el.innerHTML = `<label class="text-gray-600">${label}</label>`;
            const input = document.createElement('input');
            input.type = 'color';
            input.className = 'w-8 h-8 p-0 border-none rounded cursor-pointer bg-transparent';
            input.value = `#${color.getHexString()}`;
            input.addEventListener('input', (e) => { materialsMap.get(uuid)[property].set(e.target.value); });
            el.appendChild(input);
            return el;
        }

        function createSlider(uuid, label, value, property, min, max) {
            const el = document.createElement('div');
            el.className = 'text-sm';
            const labelEl = document.createElement('label');
            labelEl.className = 'block text-gray-600 mb-1';
            labelEl.textContent = `${label} (${(value*100).toFixed(0)}%)`;
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.min = min; slider.max = max; slider.step = 0.01;
            slider.value = value;
            slider.className = 'w-full';
            slider.addEventListener('input', (e) => {
                const newValue = parseFloat(e.target.value);
                materialsMap.get(uuid)[property] = newValue;
                labelEl.textContent = `${label} (${(newValue*100).toFixed(0)}%)`;
            });
            el.appendChild(labelEl);
            el.appendChild(slider);
            return el;
        }

        function createTextureInput(uuid, label, mapType) {
            const el = document.createElement('div');
            el.className = 'text-sm';
            el.innerHTML = `<label class="block text-gray-600 mb-1">${label}</label>`;
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.className = 'block w-full text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100';
            
            input.addEventListener('change', (e) => {
                if (!e.target.files.length) return;
                const url = URL.createObjectURL(e.target.files[0]);
                new THREE.TextureLoader().load(url, (texture) => {
                    texture.flipY = false;
                    if (mapType === 'map' || mapType === 'emissiveMap') texture.encoding = THREE.sRGBEncoding;
                    const material = materialsMap.get(uuid);
                    material[mapType] = texture;
                    material.needsUpdate = true;
                    URL.revokeObjectURL(url);
                });
            });
            el.appendChild(input);
            return el;
        }

        // --- Event Listeners Iniciais ---
        function setupEventListeners() {
            document.getElementById('new-project-btn').addEventListener('click', () => document.getElementById('new-project-modal').classList.remove('hidden'));
            document.getElementById('cancel-new-project-btn').addEventListener('click', () => document.getElementById('new-project-modal').classList.add('hidden'));
            document.getElementById('confirm-new-project-btn').addEventListener('click', () => {
                const projectName = document.getElementById('new-project-name-input').value.trim();
                if (projectName) {
                    let newProjectId = (userId && db) ? doc(collection(db, `users/${userId}/projects`)).id : Date.now().toString();
                    document.getElementById('new-project-modal').classList.add('hidden');
                    document.getElementById('new-project-name-input').value = '';
                    showEditor(newProjectId, projectName);
                } else {
                    alert('Por favor, insira um nome para o projeto.');
                }
            });
            document.getElementById('generate-thumbnail-btn').addEventListener('click', generateThumbnail);
            document.getElementById('save-project-btn').addEventListener('click', saveProject);
            document.getElementById('back-to-dashboard-btn').addEventListener('click', showDashboard);
            document.querySelectorAll('#pipeline-nav a').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    if(!button.classList.contains('disabled')) showPanel(button.id.replace('nav-', 'panel-'));
                });
            });
        }
        
        function setupToolbar() {
             const toolbarButtons = {
                'select-btn': null, 'translate-btn': 'translate', 'rotate-btn': 'rotate', 'scale-btn': 'scale',
            };
            Object.entries(toolbarButtons).forEach(([btnId, mode]) => {
                const button = document.getElementById(btnId);
                button.addEventListener('click', () => {
                    const isActive = button.classList.contains('active');
                    document.querySelectorAll('.toolbar-button').forEach(b => b.classList.remove('active'));
                    if (isActive) {
                        transformControls.detach();
                    } else {
                        button.classList.add('active');
                        if (mode) {
                            transformControls.setMode(mode);
                            transformControls.attach(currentModel);
                        } else {
                             transformControls.detach();
                        }
                    }
                });
            });
        }
        
        function setupViewerControls() {
            document.getElementById('set-initial-view-btn').addEventListener('click', () => {
                alert("Posição inicial da câmera salva!");
            });
            document.getElementById('zoom-min-input').addEventListener('change', e => orbitControls.minDistance = parseFloat(e.target.value) || 0);
            document.getElementById('zoom-max-input').addEventListener('change', e => orbitControls.maxDistance = parseFloat(e.target.value) || Infinity);
            document.getElementById('auto-rotate-toggle').addEventListener('change', e => {
                orbitControls.autoRotate = e.target.checked;
                document.getElementById('auto-rotate-controls').classList.toggle('hidden', !e.target.checked);
            });
             document.getElementById('auto-rotate-speed').addEventListener('input', e => {
                orbitControls.autoRotateSpeed = parseFloat(e.target.value);
            });
        }

        function setupExportControls() {
            document.getElementById('generate-code-btn').addEventListener('click', () => document.getElementById('export-modal').classList.remove('hidden'));
            document.getElementById('close-modal-btn').addEventListener('click', () => document.getElementById('export-modal').classList.add('hidden'));
            document.getElementById('copy-code-btn').addEventListener('click', () => {
                document.getElementById('export-code-textarea').select();
                document.execCommand('copy');
                alert("Código copiado!");
            });
            document.getElementById('download-zip-btn').addEventListener('click', () => alert('Funcionalidade de download .zip em desenvolvimento.'));
        }
        
        // --- Iniciar a aplicação ---
        setupEventListeners();
        initializeFirebase();
    </script>
</body>
</html>
